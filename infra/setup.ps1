# =============================================================================
# Azure AI Foundry v2 Infrastructure Setup
# =============================================================================
# This script creates all Azure resources for the Girls Night Out agent.
# Run after: az login
# =============================================================================

param(
    [string]$ResourceGroup = "rg-gno-dev",
    [string]$Location = "eastus",
    [string]$FoundryName = "foundry-gno",
    [string]$ProjectName = "GirlsNightOut",
    [string]$ModelDeployment = "gpt-4o"
)

$ErrorActionPreference = "Stop"

Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "  Azure AI Foundry v2 Setup" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host ""

# -----------------------------------------------------------------------------
# Step 1: Create Resource Group
# -----------------------------------------------------------------------------
Write-Host "[1/5] Creating Resource Group: $ResourceGroup" -ForegroundColor Yellow

az group create `
    --name $ResourceGroup `
    --location $Location `
    --output none

Write-Host "  ✓ Resource group created" -ForegroundColor Green

# -----------------------------------------------------------------------------
# Step 2: Create Azure AI Services / Foundry Resource
# -----------------------------------------------------------------------------
Write-Host "[2/5] Creating Azure AI Services resource: $FoundryName" -ForegroundColor Yellow

# Create Azure AI Services (multi-service) which includes OpenAI capabilities
az cognitiveservices account create `
    --name $FoundryName `
    --resource-group $ResourceGroup `
    --location $Location `
    --kind AIServices `
    --sku S0 `
    --yes `
    --output none

Write-Host "  ✓ AI Services resource created" -ForegroundColor Green

# -----------------------------------------------------------------------------
# Step 3: Deploy GPT-4o Model
# -----------------------------------------------------------------------------
Write-Host "[3/5] Deploying GPT-4o model" -ForegroundColor Yellow

az cognitiveservices account deployment create `
    --name $FoundryName `
    --resource-group $ResourceGroup `
    --deployment-name $ModelDeployment `
    --model-name "gpt-4o" `
    --model-version "2024-08-06" `
    --model-format OpenAI `
    --sku-capacity 30 `
    --sku-name Standard `
    --output none

Write-Host "  ✓ GPT-4o deployed as '$ModelDeployment'" -ForegroundColor Green

# -----------------------------------------------------------------------------
# Step 4: Get Endpoint and Keys
# -----------------------------------------------------------------------------
Write-Host "[4/5] Retrieving endpoint and keys" -ForegroundColor Yellow

$endpoint = az cognitiveservices account show `
    --name $FoundryName `
    --resource-group $ResourceGroup `
    --query "properties.endpoint" `
    --output tsv

$key = az cognitiveservices account keys list `
    --name $FoundryName `
    --resource-group $ResourceGroup `
    --query "key1" `
    --output tsv

# Build the project endpoint (new Foundry v2 format)
$projectEndpoint = "$($endpoint)api/projects/$ProjectName"
$projectEndpoint = $projectEndpoint -replace "//api", "/api"

Write-Host "  ✓ Endpoint retrieved" -ForegroundColor Green

# -----------------------------------------------------------------------------
# Step 5: Write .env file
# -----------------------------------------------------------------------------
Write-Host "[5/5] Writing .env file" -ForegroundColor Yellow

$envContent = @"
# Azure AI Foundry Configuration
# Generated by setup.ps1 on $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")

# Project endpoint (v2 format)
PROJECT_ENDPOINT=$projectEndpoint

# Model deployment name
MODEL_DEPLOYMENT_NAME=$ModelDeployment

# Agent name (will be created by setup-agent.py)
AGENT_NAME=GNOPlanner

# Azure OpenAI endpoint and key (for direct OpenAI API calls if needed)
AZURE_OPENAI_ENDPOINT=$endpoint
AZURE_OPENAI_API_KEY=$key

# Resource info
AZURE_RESOURCE_GROUP=$ResourceGroup
AZURE_FOUNDRY_NAME=$FoundryName
"@

$envPath = Join-Path $PSScriptRoot ".env"
$envContent | Out-File -FilePath $envPath -Encoding utf8 -NoNewline

# Also copy to apps/api for local development
$apiEnvPath = Join-Path $PSScriptRoot ".." "apps" "api" ".env"
$envContent | Out-File -FilePath $apiEnvPath -Encoding utf8 -NoNewline

Write-Host "  ✓ .env file created at: $envPath" -ForegroundColor Green

# -----------------------------------------------------------------------------
# Summary
# -----------------------------------------------------------------------------
Write-Host ""
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host "  Setup Complete!" -ForegroundColor Cyan
Write-Host "=============================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Resources created:" -ForegroundColor White
Write-Host "  • Resource Group: $ResourceGroup" -ForegroundColor Gray
Write-Host "  • AI Services:    $FoundryName" -ForegroundColor Gray
Write-Host "  • Model:          $ModelDeployment" -ForegroundColor Gray
Write-Host ""
Write-Host "Project Endpoint:" -ForegroundColor White
Write-Host "  $projectEndpoint" -ForegroundColor Gray
Write-Host ""
Write-Host "Next steps:" -ForegroundColor Yellow
Write-Host "  1. Create the Foundry project in portal:" -ForegroundColor White
Write-Host "     https://ai.azure.com" -ForegroundColor Gray
Write-Host ""
Write-Host "  2. Install Python dependencies:" -ForegroundColor White
Write-Host "     pip install -r infra/requirements.txt" -ForegroundColor Gray
Write-Host ""
Write-Host "  3. Run the agent setup script:" -ForegroundColor White
Write-Host "     python infra/setup-agent.py" -ForegroundColor Gray
Write-Host ""
